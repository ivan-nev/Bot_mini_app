<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–∑—å–±—ã Stub ACME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 22px;
            margin-bottom: 6px;
        }

        .header p {
            color: #666;
            font-size: 13px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-field {
            margin-bottom: 12px;
        }

        .input-field label {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-size: 13px;
            font-weight: 500;
        }

        .input-field input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .input-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .tolerance-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tolerance-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tolerance-btn:hover {
            border-color: #667eea;
        }

        .tolerance-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .tolerance-btn h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .tolerance-btn p {
            color: #666;
            font-size: 11px;
        }

        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
        }

        .results-container {
            display: none;
            gap: 15px;
        }

        .results-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
        }

        .result-section h3 {
            color: #333;
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            font-size: 16px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .result-label {
            display: flex;
            align-items: center;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }

        .icon {
            margin-right: 6px;
            font-size: 14px;
        }

        .icon.outer {
            color: #3498db;
        }

        .icon.mean {
            color: #9b59b6;
        }

        .icon.inner {
            color: #e74c3c;
        }

        .icon.height {
            color: #27ae60;
        }

        .result-value {
            color: #333;
            font-weight: 600;
            text-align: right;
            font-size: 13px;
        }

        .deviation {
            font-size: 11px;
            margin-top: 2px;
        }

        .deviation.negative {
            color: #e74c3c;
        }

        .deviation.positive {
            color: #27ae60;
        }

        .height-section {
            background: #f0f8f0;
            border-left: 3px solid #27ae60;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            display: none;
        }

        .error.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîß –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–∑—å–±—ã Stub ACME</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∑—å–±—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</p>
    </div>

    <div class="input-group">
        <div class="input-field">
            <label>–î–∏–∞–º–µ—Ç—Ä —Ä–µ–∑—å–±—ã (d), –¥—é–π–º—ã</label>
            <input type="number" id="diameter" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2.157" step="any" min="0">
        </div>
        <div class="input-field">
            <label>–®–∞–≥ (–Ω–∏—Ç–æ–∫ –Ω–∞ –¥—é–π–º)</label>
            <input type="number" id="pitch" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 8" step="any" min="0">
        </div>
    </div>

    <div class="tolerance-selector">
        <div class="tolerance-btn active" data-tolerance="2G">
            <h3>2G –ö–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</h3>
            <p>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–æ–ø—É—Å–∫</p>
        </div>
        <div class="tolerance-btn" data-tolerance="4G">
            <h3>4G –ö–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</h3>
            <p>–ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –¥–æ–ø—É—Å–∫</p>
        </div>
    </div>

    <button class="calculate-btn" onclick="calculateStubAcme()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

    <div class="error" id="errorMessage"></div>

    <div class="results-container" id="results">
        <div class="result-section">
            <h3>üî© –ù–∏–ø–ø–µ–ª—å (–º–º)</h3>
            <div id="nippleResults"></div>
        </div>
        <div class="result-section">
            <h3>üîß –ú—É—Ñ—Ç–∞ (–º–º)</h3>
            <div id="couplingResults"></div>
        </div>
        <div class="result-section height-section">
            <h3>üìè –í—ã—Å–æ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è —Ä–µ–∑—å–±—ã</h3>
            <div id="heightResults"></div>
        </div>
    </div>
</div>

<script>
    class StubAcmeCalculator {
        static calculate2G(diameter, pitch) {
            const pitchValue = 1 / pitch;

            // –ù–ò–ü–ü–ï–õ–¨ - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 2G
            const nipple = {
                outerDiameter: diameter + 0,
                outerDiameterMin: diameter - 0.05 * pitchValue,
                meanDiameter: diameter - 0.3 * pitchValue - 0.008 * Math.sqrt(diameter),
                meanDiameterMin: (diameter - 0.3 * pitchValue - 0.008 * Math.sqrt(diameter)) -
                        (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                innerDiameter: (diameter - 0.6 * pitchValue) - 0.02,
                innerDiameterMin: (diameter - 0.6 * pitchValue) - 0.02 -
                        (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue))
            };

            // –ú–£–§–¢–ê - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 2G
            const coupling = {
                outerDiameterMax: (diameter + 0.02) + (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                outerDiameter: diameter + 0.02,
                meanDiameterMax: (diameter - 0.3 * pitchValue) + (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                meanDiameter: diameter - 0.3 * pitchValue,
                innerDiameterMax: (diameter - 0.6 * pitchValue) + 0.05 * pitchValue,
                innerDiameter: diameter - 0.6 * pitchValue
            };

            return {nipple, coupling};
        }

        static calculate4G(diameter, pitch) {
            const pitchValue = 1 / pitch;

            // –ù–ò–ü–ü–ï–õ–¨ - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 4G
            const nipple = {
                outerDiameter: diameter + 0,
                outerDiameterMin: diameter - 0.05 * pitchValue,
                meanDiameter: diameter - 0.3 * pitchValue - 0.004 * Math.sqrt(diameter),
                meanDiameterMin: (diameter - 0.3 * pitchValue - 0.004 * Math.sqrt(diameter)) -
                        (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                innerDiameter: (diameter - 0.6 * pitchValue) - 0.02,
                innerDiameterMin: (diameter - 0.6 * pitchValue) - 0.02 -
                        (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue))
            };

            // –ú–£–§–¢–ê - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 4G
            const coupling = {
                outerDiameterMax: (diameter + 0.02) + (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                outerDiameter: diameter + 0.02,
                meanDiameterMax: (diameter - 0.3 * pitchValue) + (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                meanDiameter: diameter - 0.3 * pitchValue,
                innerDiameterMax: (diameter - 0.6 * pitchValue) + 0.05 * pitchValue,
                innerDiameter: diameter - 0.6 * pitchValue
            };

            return {nipple, coupling};
        }

        static inchesToMm(inches) {
            return inches * 25.4;
        }

        static calculateThreadHeight(pitch) {
            // –†–∞—Å—á–µ—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∏—Ç–æ–∫ –Ω–∞ –¥—é–π–º
            const heightMap = {
                12: {value: 0.8, deviation: 0.1},
                10: {value: 1.1, deviation: 0.1},
                8: {value: 1.3, deviation: 0.1},
                6: {value: 1.6, deviation: 0.1},
                5: {value: 1.85, deviation: 0.1},
                4: {value: 2.2, deviation: 0.1}
            };

            const roundedPitch = Math.round(pitch);

            if (heightMap[roundedPitch]) {
                return heightMap[roundedPitch];
            } else {
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                const pitches = Object.keys(heightMap).map(Number).sort((a, b) => a - b);
                let lower = pitches[0];
                let upper = pitches[pitches.length - 1];

                for (let i = 0; i < pitches.length - 1; i++) {
                    if (roundedPitch >= pitches[i] && roundedPitch <= pitches[i + 1]) {
                        lower = pitches[i];
                        upper = pitches[i + 1];
                        break;
                    }
                }

                const lowerHeight = heightMap[lower];
                const upperHeight = heightMap[upper];
                const ratio = (roundedPitch - lower) / (upper - lower);

                const value = lowerHeight.value + (upperHeight.value - lowerHeight.value) * ratio;
                return {value: parseFloat(value.toFixed(2)), deviation: 0.1};
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.setText("–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º");
    tg.MainButton.hide();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞ –¥–æ–ø—É—Å–∫–∞
    document.querySelectorAll('.tolerance-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tolerance-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            hideResults();
        });
    });

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.classList.add('active');
        hideResults();
    }

    function hideError() {
        document.getElementById('errorMessage').classList.remove('active');
    }

    function showResults() {
        hideError();
        document.getElementById('results').classList.add('active');
        tg.MainButton.show();
    }

    function hideResults() {
        document.getElementById('results').classList.remove('active');
        tg.MainButton.hide();
    }

    function formatNumber(value, decimals = 3) {
        return parseFloat(value.toFixed(decimals));
    }

    function calculateStubAcme() {
        const diameter = parseFloat(document.getElementById('diameter').value);
        const pitch = parseFloat(document.getElementById('pitch').value);
        const tolerance = document.querySelector('.tolerance-btn.active').dataset.tolerance;

        if (!diameter || !pitch) {
            showError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            return;
        }

        if (diameter <= 0 || pitch <= 0) {
            showError("–ó–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏");
            return;
        }

        try {
            let result;
            if (tolerance === '2G') {
                result = StubAcmeCalculator.calculate2G(diameter, pitch);
            } else {
                result = StubAcmeCalculator.calculate4G(diameter, pitch);
            }

            // –†–∞—Å—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–ª—è –ù–ò–ü–ü–ï–õ–Ø (–º–∏–Ω—É—Å–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏)
            const nippleOuterMm = StubAcmeCalculator.inchesToMm(result.nipple.outerDiameter);
            const nippleOuterMinMm = StubAcmeCalculator.inchesToMm(result.nipple.outerDiameterMin);
            const nippleOuterDeviation = formatNumber(nippleOuterMm - nippleOuterMinMm, 3);

            const nippleMeanMm = StubAcmeCalculator.inchesToMm(result.nipple.meanDiameter);
            const nippleMeanMinMm = StubAcmeCalculator.inchesToMm(result.nipple.meanDiameterMin);
            const nippleMeanDeviation = formatNumber(nippleMeanMm - nippleMeanMinMm, 3);

            const nippleInnerMm = StubAcmeCalculator.inchesToMm(result.nipple.innerDiameter);
            const nippleInnerMinMm = StubAcmeCalculator.inchesToMm(result.nipple.innerDiameterMin);
            const nippleInnerDeviation = formatNumber(nippleInnerMm - nippleInnerMinMm, 3);

            // –†–∞—Å—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –¥–ª—è –ú–£–§–¢–´ (–ø–ª—é—Å–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏)
            const couplingOuterMm = StubAcmeCalculator.inchesToMm(result.coupling.outerDiameter);
            const couplingOuterMaxMm = StubAcmeCalculator.inchesToMm(result.coupling.outerDiameterMax);
            const couplingOuterDeviation = formatNumber(couplingOuterMaxMm - couplingOuterMm, 3);

            const couplingMeanMm = StubAcmeCalculator.inchesToMm(result.coupling.meanDiameter);
            const couplingMeanMaxMm = StubAcmeCalculator.inchesToMm(result.coupling.meanDiameterMax);
            const couplingMeanDeviation = formatNumber(couplingMeanMaxMm - couplingMeanMm, 3);

            const couplingInnerMm = StubAcmeCalculator.inchesToMm(result.coupling.innerDiameter);
            const couplingInnerMaxMm = StubAcmeCalculator.inchesToMm(result.coupling.innerDiameterMax);
            const couplingInnerDeviation = formatNumber(couplingInnerMaxMm - couplingInnerMm, 3);

            // –†–∞—Å—á–µ—Ç –≤—ã—Å–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            const threadHeight = StubAcmeCalculator.calculateThreadHeight(pitch);

            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –Ω–∏–ø–ø–µ–ª—è (–º–∏–Ω—É—Å–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏)
            const nippleHtml = `
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon outer">‚≠ï</span>–ù–∞—Ä—É–∂–Ω—ã–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(nippleOuterMm, 3)}
                            <div class="deviation negative">-${nippleOuterDeviation}</div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon mean">üìä</span>–°—Ä–µ–¥–Ω–∏–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(nippleMeanMm, 3)}
                            <div class="deviation negative">-${nippleMeanDeviation}</div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon inner">üï≥Ô∏è</span>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(nippleInnerMm, 3)}
                            <div class="deviation negative">-${nippleInnerDeviation}</div>
                        </div>
                    </div>
                `;

            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –º—É—Ñ—Ç—ã (–ø–ª—é—Å–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏)
            const couplingHtml = `
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon outer">‚≠ï</span>–ù–∞—Ä—É–∂–Ω—ã–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(couplingOuterMm, 3)}
                            <div class="deviation positive">+${couplingOuterDeviation}</div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon mean">üìä</span>–°—Ä–µ–¥–Ω–∏–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(couplingMeanMm, 3)}
                            <div class="deviation positive">+${couplingMeanDeviation}</div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon inner">üï≥Ô∏è</span>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π:
                        </span>
                        <div class="result-value">
                            ${formatNumber(couplingInnerMm, 3)}
                            <div class="deviation positive">+${couplingInnerDeviation}</div>
                        </div>
                    </div>
                `;

            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –≤—ã—Å–æ—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
            const heightHtml = `
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon height">üìê</span>–†–∞—Å—á–µ—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞:
                        </span>
                        <div class="result-value">
                            ${threadHeight.value} –º–º
                            <div class="deviation positive">+${threadHeight.deviation}</div>
                        </div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">
                            <span class="icon height">üî¢</span>–î–ª—è —à–∞–≥–∞:
                        </span>
                        <div class="result-value">${Math.round(pitch)} –Ω–∏—Ç–æ–∫/–¥—é–π–º</div>
                    </div>
                `;

            document.getElementById('nippleResults').innerHTML = nippleHtml;
            document.getElementById('couplingResults').innerHTML = couplingHtml;
            document.getElementById('heightResults').innerHTML = heightHtml;
            showResults();

        } catch (error) {
            showError("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: " + error.message);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º"
    tg.MainButton.onClick(() => {
        const nippleText = document.getElementById('nippleResults').innerText;
        const couplingText = document.getElementById('couplingResults').innerText;
        const heightText = document.getElementById('heightResults').innerText;
        tg.sendData(JSON.stringify({
            action: "share_stub_acme_result",
            tolerance: document.querySelector('.tolerance-btn.active').dataset.tolerance,
            nipple: nippleText,
            coupling: couplingText,
            height: heightText
        }));
    });

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('diameter').value = '2.157';
    document.getElementById('pitch').value = '8';
</script>
</body>
</html>