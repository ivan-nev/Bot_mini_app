<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–∑—å–±—ã Stub ACME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 22px;
            margin-bottom: 6px;
        }

        .header p {
            color: #666;
            font-size: 13px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
            align-items: end;
        }

        .input-field {
            margin-bottom: 0;
        }

        .input-field label {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .input-field input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .input-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .tolerance-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tolerance-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tolerance-btn:hover {
            border-color: #667eea;
        }

        .tolerance-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .tolerance-btn h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .tolerance-btn p {
            color: #666;
            font-size: 11px;
        }

        .calculate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
        }

        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            vertical-align: middle;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .parameter-name {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-weight: 500;
            color: #555;
            padding-left: 15px;
            height: 100%;
            min-height: 40px;
        }

        .parameter-name.two-lines {
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }

        .parameter-name.two-lines .empty-line {
            height: 14px;
            visibility: hidden;
        }

        .icon {
            margin-right: 6px;
            font-size: 14px;
        }

        .icon.outer {
            color: #3498db;
        }

        .icon.mean {
            color: #9b59b6;
        }

        .icon.inner {
            color: #e74c3c;
        }

        .icon.height {
            color: #27ae60;
        }

        .diameter-value {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .deviation {
            font-size: 11px;
        }

        .deviation.negative {
            color: #e74c3c;
        }

        .deviation.positive {
            color: #27ae60;
        }

        .height-row {
            background: #f0f8f0 !important;
        }

        .height-value {
            font-weight: 600;
            color: #27ae60;
        }

        .pitch-info {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            display: none;
        }

        .error.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîß –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–∑—å–±—ã Stub ACME</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∑—å–±—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</p>
    </div>

    <div class="input-group">
        <div class="input-field">
            <label>–î–∏–∞–º–µ—Ç—Ä (d), –¥—é–π–º—ã</label>
            <input type="number" id="diameter" placeholder="2.157" step="any" min="0">
        </div>
        <div class="input-field">
            <label>–®–∞–≥ (–Ω–∏—Ç–æ–∫/–¥—é–π–º)</label>
            <input type="number" id="pitch" placeholder="8" step="any" min="0">
        </div>
    </div>

    <div class="tolerance-selector">
        <div class="tolerance-btn active" data-tolerance="2G">
            <h3>2G –ö–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</h3>
            <p>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–æ–ø—É—Å–∫</p>
        </div>
        <div class="tolerance-btn" data-tolerance="4G">
            <h3>4G –ö–ª–∞—Å—Å –¥–æ–ø—É—Å–∫–∞</h3>
            <p>–ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –¥–æ–ø—É—Å–∫</p>
        </div>
    </div>

    <button class="calculate-btn" onclick="calculateStubAcme()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

    <div class="error" id="errorMessage"></div>

    <div class="results-container" id="results">
        <table class="results-table">
            <thead>
            <tr>
                <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                <th>–ù–∏–ø–ø–µ–ª—å (–º–º)</th>
                <th>–ú—É—Ñ—Ç–∞ (–º–º)</th>
            </tr>
            </thead>
            <tbody id="resultsBody">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </tbody>
        </table>
    </div>
</div>

<script>
    class StubAcmeCalculator {
        static calculate2G(diameter, pitch) {
            const pitchValue = 1 / pitch;

            // –ù–ò–ü–ü–ï–õ–¨ - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 2G
            const nipple = {
                outerDiameter: diameter + 0,
                outerDiameterMin: diameter - 0.05 * pitchValue,
                meanDiameter: diameter - 0.3 * pitchValue - 0.008 * Math.sqrt(diameter),
                meanDiameterMin: (diameter - 0.3 * pitchValue - 0.008 * Math.sqrt(diameter)) -
                        (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                innerDiameter: (diameter - 0.6 * pitchValue) - 0.02,
                innerDiameterMin: (diameter - 0.6 * pitchValue) - 0.02 -
                        (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue))
            };

            // –ú–£–§–¢–ê - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 2G
            const coupling = {
                outerDiameterMax: (diameter + 0.02) + (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                outerDiameter: diameter + 0.02,
                meanDiameterMax: (diameter - 0.3 * pitchValue) + (0.006 * Math.sqrt(diameter) + 0.03 * Math.sqrt(pitchValue)),
                meanDiameter: diameter - 0.3 * pitchValue,
                innerDiameterMax: (diameter - 0.6 * pitchValue) + 0.05 * pitchValue,
                innerDiameter: diameter - 0.6 * pitchValue
            };

            return {nipple, coupling};
        }

        static calculate4G(diameter, pitch) {
            const pitchValue = 1 / pitch;

            // –ù–ò–ü–ü–ï–õ–¨ - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 4G
            const nipple = {
                outerDiameter: diameter + 0,
                outerDiameterMin: diameter - 0.05 * pitchValue,
                meanDiameter: diameter - 0.3 * pitchValue - 0.004 * Math.sqrt(diameter),
                meanDiameterMin: (diameter - 0.3 * pitchValue - 0.004 * Math.sqrt(diameter)) -
                        (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                innerDiameter: (diameter - 0.6 * pitchValue) - 0.02,
                innerDiameterMin: (diameter - 0.6 * pitchValue) - 0.02 -
                        (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue))
            };

            // –ú–£–§–¢–ê - —Ñ–æ—Ä–º—É–ª—ã –∏–∑ –ª–∏—Å—Ç–∞ 4G
            const coupling = {
                outerDiameterMax: (diameter + 0.02) + (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                outerDiameter: diameter + 0.02,
                meanDiameterMax: (diameter - 0.3 * pitchValue) + (0.002 * Math.sqrt(diameter) + 0.01 * Math.sqrt(pitchValue)),
                meanDiameter: diameter - 0.3 * pitchValue,
                innerDiameterMax: (diameter - 0.6 * pitchValue) + 0.05 * pitchValue,
                innerDiameter: diameter - 0.6 * pitchValue
            };

            return {nipple, coupling};
        }

        static inchesToMm(inches) {
            return inches * 25.4;
        }

        static calculateThreadHeight(pitch) {
            // –†–∞—Å—á–µ—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–∏—Ç–æ–∫ –Ω–∞ –¥—é–π–º
            const heightMap = {
                12: {value: 0.8, deviation: 0.1},
                10: {value: 1.1, deviation: 0.1},
                8: {value: 1.3, deviation: 0.1},
                6: {value: 1.6, deviation: 0.1},
                5: {value: 1.85, deviation: 0.1},
                4: {value: 2.2, deviation: 0.1}
            };

            const roundedPitch = Math.round(pitch);

            if (heightMap[roundedPitch]) {
                return heightMap[roundedPitch];
            } else {
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                const pitches = Object.keys(heightMap).map(Number).sort((a, b) => a - b);
                let lower = pitches[0];
                let upper = pitches[pitches.length - 1];

                for (let i = 0; i < pitches.length - 1; i++) {
                    if (roundedPitch >= pitches[i] && roundedPitch <= pitches[i + 1]) {
                        lower = pitches[i];
                        upper = pitches[i + 1];
                        break;
                    }
                }

                const lowerHeight = heightMap[lower];
                const upperHeight = heightMap[upper];
                const ratio = (roundedPitch - lower) / (upper - lower);

                const value = lowerHeight.value + (upperHeight.value - lowerHeight.value) * ratio;
                return {value: parseFloat(value.toFixed(2)), deviation: 0.1};
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App - –ì–õ–û–ë–ê–õ–¨–ù–û
    let tg = window.Telegram.WebApp;
    tg.expand();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è MainButton
    tg.MainButton.setText("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º");
    tg.MainButton.onClick(() => {
        console.log("MainButton clicked");
        shareToTelegram();
    });
    tg.MainButton.hide();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞ –¥–æ–ø—É—Å–∫–∞
    document.querySelectorAll('.tolerance-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tolerance-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            hideResults();
        });
    });

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.classList.add('active');
        hideResults();
    }

    function hideError() {
        document.getElementById('errorMessage').classList.remove('active');
    }

    function showResults() {
        hideError();
        document.getElementById('results').classList.add('active');
        tg.MainButton.show(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º MainButton Telegram
    }

    function hideResults() {
        document.getElementById('results').classList.remove('active');
        tg.MainButton.hide(); // –°–∫—Ä—ã–≤–∞–µ–º MainButton Telegram
    }

    function formatNumber(value, decimals = 3) {
        return parseFloat(value.toFixed(decimals));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
    function shareToTelegram() {
        console.log("shareToTelegram called");

        const diameter = document.getElementById('diameter').value;
        const pitch = document.getElementById('pitch').value;
        const tolerance = document.querySelector('.tolerance-btn.active').dataset.tolerance;

        // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const rows = document.querySelectorAll('#resultsBody tr');
        const results = [];

        rows.forEach(row => {
            const paramElement = row.querySelector('.parameter-name');
            const paramText = paramElement ?
                    paramElement.textContent.replace(/[‚≠ïüî©üï≥Ô∏èüìê]/g, '').trim() : '';

            const nippleCell = row.cells[1];
            const couplingCell = row.cells[2];

            const nippleValue = nippleCell.querySelector('.diameter-value, .height-value')?.textContent || '';
            const couplingValue = couplingCell.querySelector('.diameter-value, .height-value')?.textContent || '';

            const nippleDeviations = [];
            const couplingDeviations = [];

            nippleCell.querySelectorAll('.deviation')
                    .forEach(el => nippleDeviations.push(el.textContent));
            couplingCell.querySelectorAll('.deviation')
                    .forEach(el => couplingDeviations.push(el.textContent));

            results.push({
                parameter: paramText,
                nipple: {
                    value: nippleValue,
                    deviations: nippleDeviations
                },
                coupling: {
                    value: couplingValue,
                    deviations: couplingDeviations
                }
            });
        });

        const data = {
            action: "share_stub_acme_result",
            diameter: diameter,
            pitch: pitch,
            tolerance: tolerance,
            results: results,
            raw_text: document.getElementById('resultsBody').innerText,
            timestamp: new Date().toISOString()
        };

        console.log("Sending data to Telegram:", data);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
        const success = tg.sendData(JSON.stringify(data));

        if (success) {
            console.log("Data sent successfully");
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            tg.showAlert("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram!");
        } else {
            console.log("Failed to send data");
            tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
        }
    }

    function calculateStubAcme() {
        const diameter = parseFloat(document.getElementById('diameter').value);
        const pitch = parseFloat(document.getElementById('pitch').value);
        const tolerance = document.querySelector('.tolerance-btn.active').dataset.tolerance;

        if (!diameter || !pitch) {
            showError("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            return;
        }

        if (diameter <= 0 || pitch <= 0) {
            showError("–ó–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏");
            return;
        }

        try {
            let result;
            if (tolerance === '2G') {
                result = StubAcmeCalculator.calculate2G(diameter, pitch);
            } else {
                result = StubAcmeCalculator.calculate4G(diameter, pitch);
            }

            // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

            document.getElementById('resultsBody').innerHTML = resultsHtml;
            showResults(); // –¢–µ–ø–µ—Ä—å MainButton –ø–æ—è–≤–∏—Ç—Å—è

        } catch (error) {
            showError("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: " + error.message);
        }
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('diameter').value = '2.157';
    document.getElementById('pitch').value = '8';

    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram Web App
    console.log("Telegram Web App initialized:", {
        platform: tg.platform,
        version: tg.version,
        initData: tg.initData ? "present" : "absent",
        initDataUnsafe: tg.initDataUnsafe
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ Telegram Web App
    if (!tg.initData) {
        console.warn("Telegram Web App not properly initialized. Running in browser mode.");
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        window.testShare = function () {
            alert("–í —Ä–µ–∂–∏–º–µ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram.");
        };
    }
</script>
</body>
</html>