<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
            overflow-wrap: break-word;
        }

        .button {
            width: 100%;
            padding: 12px;
            background-color: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .button:hover {
            background-color: #006699;
        }

        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            min-height: 60px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        p {
            color: #666;
            margin-bottom: 15px;
        }

        .data-item {
            margin: 8px 0;
        }

        .label {
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üì± –¢–µ—Å—Ç–æ–≤–æ–µ Mini App</h1>
        <p>–ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram</p>
    </div>

    <div class="card">
        <div class="info">
            –≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.
        </div>

        <div id="userInfo" class="data-display">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>
        </div>

        <div class="data-display">
            <p><strong>–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è:</strong></p>
            <div class="data-item"><span class="label">–î–µ–π—Å—Ç–≤–∏–µ:</span> test_button_click</div>
            <div class="data-item"><span class="label">–ó–Ω–∞—á–µ–Ω–∏–µ:</span> –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
            <div class="data-item"><span class="label">–í—Ä–µ–º—è:</span> <span id="timestamp"></span></div>
        </div>

        <button class="button" id="sendButton" onclick="sendTestData()">
            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        </button>

        <button class="button" onclick="sendCustomData()" style="background-color: #28a745;">
            ‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        </button>
    </div>

    <div class="result" id="result">
        <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏...</p>
    </div>

    <div class="card">
        <h3>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <div class="data-display">
            <p><strong>–≠–Ω–¥–ø–æ–∏–Ω—Ç:</strong> /api/submit-data</p>
            <p><strong>–ú–µ—Ç–æ–¥:</strong> POST</p>
            <p><strong>–§–æ—Ä–º–∞—Ç:</strong> JSON</p>
            <p><strong>–ü–æ–ª—è:</strong> value, initData</p>
        </div>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É
    tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É —Å–Ω–∏–∑—É");
    tg.MainButton.show();
    tg.MainButton.onClick(sendTestData);

    // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.expand();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    function updateUserInfo() {
        const userInfoDiv = document.getElementById('userInfo');

        if (tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            let html = '<p><strong>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</strong></p>';
            html += `<p><span class="label">ID:</span> ${user.id}</p>`;
            html += `<p><span class="label">–ò–º—è:</span> ${user.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>`;
            if (user.last_name) html += `<p><span class="label">–§–∞–º–∏–ª–∏—è:</span> ${user.last_name}</p>`;
            if (user.username) html += `<p><span class="label">Username:</span> @${user.username}</p>`;

            userInfoDiv.innerHTML = html;
        } else {
            userInfoDiv.innerHTML = '<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º timestamp
    function updateTimestamp() {
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function sendTestData() {
        const resultDiv = document.getElementById('result');
        const sendButton = document.getElementById('sendButton');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        resultDiv.className = 'result loading';
        resultDiv.innerHTML = '<p>‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</p>';
        sendButton.disabled = true;
        sendButton.textContent = 'üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const data = {
                value: `–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${new Date().toLocaleTimeString()}`,
                initData: tg.initData
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/submit-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
            if (!response.ok) {
                throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                        <p>‚úÖ <strong>–£—Å–ø–µ—à–Ω–æ!</strong></p>
                        <p>–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>
                        <p>–¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
                        <p style="margin-top: 10px; font-size: 12px;">–°—Ç–∞—Ç—É—Å: ${result.message}</p>
                    `;

                // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }

            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                        <p>‚ö†Ô∏è <strong>–û—à–∏–±–∫–∞:</strong></p>
                        <p>${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    `;
            }

        } catch (error) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `
                    <p>‚ùå <strong>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong></p>
                    <p>${error.message}</p>
                `;
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            sendButton.disabled = false;
            sendButton.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ';
            updateTimestamp();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function sendCustomData() {
        const resultDiv = document.getElementById('result');

        // –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É)
        const customValue = prompt('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', '–ú–æ–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');

        if (!customValue) {
            return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        resultDiv.className = 'result loading';
        resultDiv.innerHTML = '<p>‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</p>';

        try {
            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const data = {
                value: customValue,
                initData: tg.initData
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/submit-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.status === 'success') {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                        <p>‚úÖ <strong>–ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!</strong></p>
                        <p>–ó–Ω–∞—á–µ–Ω–∏–µ: "${customValue}"</p>
                        <p>–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</p>
                    `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                        <p>‚ö†Ô∏è <strong>–û—à–∏–±–∫–∞:</strong></p>
                        <p>${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    `;
            }

        } catch (error) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `
                    <p>‚ùå <strong>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong></p>
                    <p>${error.message}</p>
                `;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        updateUserInfo();
        updateTimestamp();

        // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateTimestamp, 1000);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é WebApp
        console.log('Telegram WebApp version:', tg.version);
        console.log('Platform:', tg.platform);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    function closeApp() {
        tg.close();
    }
</script>
</body>
</html>