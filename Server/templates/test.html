<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test InitData Validation</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .test-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        textarea:focus {
            border-color: #667eea;
            outline: none;
        }

        .data-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .result {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 100px;
        }

        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .field-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #667eea;
            outline: none;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #bee5eb;
        }

        .info-box h3 {
            margin-top: 0;
            color: #0c5460;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 5px;
        }

        .status-valid {
            background: #28a745;
            color: white;
        }

        .status-invalid {
            background: #dc3545;
            color: white;
        }

        .status-unknown {
            background: #6c757d;
            color: white;
        }

        .response-details {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .response-details h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .copy-btn {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            margin: 5px;
        }

        .copy-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ initData</h1>

    <div class="info-box">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h3>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ initData –æ—Ç Telegram WebApp.</p>
        <p>–í—ã –º–æ–∂–µ—Ç–µ:</p>
        <ol>
            <li>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram</li>
            <li>–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏</li>
            <li>–ò–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üì± –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ Telegram WebApp</h2>
        <div class="data-display" id="currentInitData">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram...
        </div>
        <div class="button-group">
            <button class="btn-primary" onclick="loadCurrentData()">
                üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            </button>
            <button class="btn-secondary" onclick="useCurrentDataForTest()">
                üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>
        <div class="field-group">
            <label for="testUserId">User ID:</label>
            <input type="number" id="testUserId" value="123456789" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>
        <div class="field-group">
            <label for="testFirstName">First Name:</label>
            <input type="text" id="testFirstName" value="TestUser" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        </div>
        <div class="field-group">
            <label for="testUsername">Username (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <input type="text" id="testUsername" value="test_user" placeholder="–í–≤–µ–¥–∏—Ç–µ username">
        </div>
        <div class="button-group">
            <button class="btn-success" onclick="generateTestData()">
                üõ†Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä initData –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <textarea id="initDataEditor" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ initData –∑–¥–µ—Å—å..."></textarea>

        <div class="button-group">
            <button class="btn-warning" onclick="modifyHash()">
                üîÑ –ò–∑–º–µ–Ω–∏—Ç—å hash (—Å–¥–µ–ª–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º)
            </button>
            <button class="btn-warning" onclick="modifyUserId()">
                üë§ –ò–∑–º–µ–Ω–∏—Ç—å User ID
            </button>
            <button class="btn-warning" onclick="modifyAuthDate()">
                ‚è∞ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            </button>
            <button class="btn-danger" onclick="clearData()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
            <button class="btn-secondary" onclick="parseAndDisplay()">
                üîç –ü–∞—Ä—Å–∏—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å
            </button>
        </div>

        <div id="parsedData" class="data-display" style="display: none;">
            –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>

    <div class="test-section">
        <h2>üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h2>
        <div class="field-group">
            <label for="testValue">–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (value):</label>
            <input type="text" id="testValue" value="–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏">
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="sendValidRequest()">
                ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            </button>
            <button class="btn-danger" onclick="sendInvalidRequest()">
                ‚ùå –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            </button>
            <button class="btn-secondary" onclick="sendCustomRequest()">
                üîß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
            </button>
        </div>
    </div>

    <div class="test-section">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="testResult" class="result">
            –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...
        </div>

        <div id="responseDetails" class="response-details" style="display: none;">
            <h4>–î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞:</h4>
            <pre id="responseDetailsContent"></pre>
            <button class="copy-btn" onclick="copyResponseDetails()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
        </div>

        <div id="testSummary" style="margin-top: 20px;"></div>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    let currentInitData = '';
    let testResults = [];

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö Telegram
    function loadCurrentData() {
        const display = document.getElementById('currentInitData');

        if (tg && tg.initData) {
            currentInitData = tg.initData;
            display.textContent = currentInitData;
            display.style.backgroundColor = '#d4edda';

            // –ü–∞—Ä—Å–∏–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const parsed = parseInitData(currentInitData);
            const userInfo = parsed.user ? JSON.parse(parsed.user) : {};

            let infoHtml = 'üì± –î–∞–Ω–Ω—ã–µ Telegram WebApp:\n\n';
            infoHtml += `üîë Hash: ${parsed.hash ? '–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}\n`;
            infoHtml += `‚è∞ Auth Date: ${parsed.auth_date || '–ù–µ—Ç'}\n`;
            infoHtml += `üë§ User: ${userInfo.first_name || '–ù–µ—Ç'} (ID: ${userInfo.id || '–ù–µ—Ç'})\n`;
            infoHtml += `üìä Query ID: ${parsed.query_id || '–ù–µ—Ç'}\n`;

            display.textContent = infoHtml + '\n\n–ü–æ–ª–Ω—ã–π initData:\n' + currentInitData;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            document.getElementById('initDataEditor').value = currentInitData;

            addTestResult('–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ Telegram –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        } else {
            display.textContent = 'Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            display.style.backgroundColor = '#f8d7da';
            addTestResult('Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
        }
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ initData
    function parseInitData(initData) {
        const params = new URLSearchParams(initData);
        const result = {};

        for (const [key, value] of params) {
            result[key] = value;
        }

        return result;
    }

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ initData –∏–∑ –æ–±—ä–µ–∫—Ç–∞
    function stringifyInitData(data) {
        const params = new URLSearchParams();

        for (const [key, value] of Object.entries(data)) {
            params.append(key, value);
        }

        return params.toString();
    }

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞
    function useCurrentDataForTest() {
        if (currentInitData) {
            document.getElementById('initDataEditor').value = currentInitData;
            parseAndDisplay();
            addTestResult('–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'success');
        } else {
            alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ Telegram');
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function generateTestData() {
        const userId = document.getElementById('testUserId').value;
        const firstName = document.getElementById('testFirstName').value;
        const username = document.getElementById('testUsername').value;

        const userData = {
            id: parseInt(userId),
            first_name: firstName,
            username: username || undefined
        };

        // –£–¥–∞–ª—è–µ–º undefined –ø–æ–ª—è
        Object.keys(userData).forEach(key => userData[key] === undefined && delete userData[key]);

        const initData = {
            user: JSON.stringify(userData),
            auth_date: Math.floor(Date.now() / 1000).toString(),
            hash: 'test_hash_' + Math.random().toString(36).substring(7)
        };

        const initDataString = stringifyInitData(initData);
        document.getElementById('initDataEditor').value = initDataString;

        addTestResult(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${firstName} (ID: ${userId})`, 'success');
    }

    // –ò–∑–º–µ–Ω–∏—Ç—å hash (—Å–¥–µ–ª–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º)
    function modifyHash() {
        const editor = document.getElementById('initDataEditor');
        let initData = editor.value;

        if (!initData) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ initData');
            return;
        }

        const parsed = parseInitData(initData);

        // –ò–∑–º–µ–Ω—è–µ–º hash
        if (parsed.hash) {
            // –ò–∑–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª hash
            const oldHash = parsed.hash;
            parsed.hash = oldHash.slice(0, -1) + (oldHash.slice(-1) === 'a' ? 'b' : 'a');

            editor.value = stringifyInitData(parsed);
            addTestResult(`Hash –∏–∑–º–µ–Ω–µ–Ω: ${oldHash.slice(0, 10)}... ‚Üí ${parsed.hash.slice(0, 10)}...`, 'warning');
        } else {
            parsed.hash = 'invalid_hash_' + Math.random().toString(36).substring(7);
            editor.value = stringifyInitData(parsed);
            addTestResult('–î–æ–±–∞–≤–ª–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π hash', 'warning');
        }
    }

    // –ò–∑–º–µ–Ω–∏—Ç—å User ID
    function modifyUserId() {
        const editor = document.getElementById('initDataEditor');
        let initData = editor.value;

        if (!initData) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ initData');
            return;
        }

        const parsed = parseInitData(initData);

        if (parsed.user) {
            try {
                const user = JSON.parse(parsed.user);
                const oldId = user.id;
                user.id = oldId + 1; // –ò–∑–º–µ–Ω—è–µ–º ID
                parsed.user = JSON.stringify(user);

                editor.value = stringifyInitData(parsed);
                addTestResult(`User ID –∏–∑–º–µ–Ω–µ–Ω: ${oldId} ‚Üí ${user.id}`, 'warning');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ user –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
            }
        } else {
            alert('–ü–æ–ª–µ user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ initData');
        }
    }

    // –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function modifyAuthDate() {
        const editor = document.getElementById('initDataEditor');
        let initData = editor.value;

        if (!initData) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ initData');
            return;
        }

        const parsed = parseInitData(initData);

        if (parsed.auth_date) {
            const oldDate = parsed.auth_date;
            // –£–º–µ–Ω—å—à–∞–µ–º –¥–∞—Ç—É –Ω–∞ 1 –¥–µ–Ω—å (86400 —Å–µ–∫—É–Ω–¥)
            parsed.auth_date = (parseInt(oldDate) - 86400).toString();

            editor.value = stringifyInitData(parsed);
            addTestResult(`Auth date –∏–∑–º–µ–Ω–µ–Ω–∞: ${oldDate} ‚Üí ${parsed.auth_date}`, 'warning');
        } else {
            parsed.auth_date = Math.floor(Date.now() / 1000).toString();
            editor.value = stringifyInitData(parsed);
            addTestResult('–î–æ–±–∞–≤–ª–µ–Ω–∞ auth date', 'warning');
        }
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    function clearData() {
        document.getElementById('initDataEditor').value = '';
        document.getElementById('parsedData').style.display = 'none';
        addTestResult('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'info');
    }

    // –ü–∞—Ä—Å–∏—Ç—å –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    function parseAndDisplay() {
        const editor = document.getElementById('initDataEditor');
        const display = document.getElementById('parsedData');

        if (!editor.value) {
            alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞');
            return;
        }

        try {
            const parsed = parseInitData(editor.value);
            let displayText = 'üìã –ü–∞—Ä—Å–∏–Ω–≥ initData:\n\n';

            for (const [key, value] of Object.entries(parsed)) {
                if (key === 'user') {
                    try {
                        const userData = JSON.parse(value);
                        displayText += `${key}: ${JSON.stringify(userData, null, 2)}\n`;
                    } catch {
                        displayText += `${key}: ${value}\n`;
                    }
                } else {
                    displayText += `${key}: ${value}\n`;
                }
            }

            display.textContent = displayText;
            display.style.display = 'block';

            addTestResult('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã', 'success');
        } catch (e) {
            display.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: ' + e.message;
            display.style.display = 'block';
            display.style.backgroundColor = '#f8d7da';

            addTestResult('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö: ' + e.message, 'error');
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    async function sendValidRequest() {
        const testValue = document.getElementById('testValue').value;
        let initData = document.getElementById('initDataEditor').value;

        // –ï—Å–ª–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –ø—É—Å—Ç–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Telegram
        if (!initData && tg && tg.initData) {
            initData = tg.initData;
        }

        if (!initData) {
            alert('–í–≤–µ–¥–∏—Ç–µ initData –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Telegram');
            return;
        }

        await sendRequest(testValue, initData, '–í–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å');
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    async function sendInvalidRequest() {
        const testValue = document.getElementById('testValue').value;
        let initData = document.getElementById('initDataEditor').value;

        if (!initData) {
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≤–µ–¥–æ–º–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            initData = 'user=%7B%22id%22%3A999999%2C%22first_name%22%3A%22InvalidUser%22%7D&auth_date=1234567890&hash=invalid_hash_12345';
        } else {
            // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            const parsed = parseInitData(initData);
            parsed.hash = 'deliberately_invalid_hash_' + Date.now();
            initData = stringifyInitData(parsed);
        }

        await sendRequest(testValue, initData, '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å');
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
    async function sendCustomRequest() {
        const testValue = document.getElementById('testValue').value;
        const initData = document.getElementById('initDataEditor').value;

        if (!initData) {
            alert('–í–≤–µ–¥–∏—Ç–µ initData –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ');
            return;
        }

        await sendRequest(testValue, initData, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å');
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    async function sendRequest(value, initData, requestType) {
        const resultDiv = document.getElementById('testResult');
        const detailsDiv = document.getElementById('responseDetails');
        const detailsContent = document.getElementById('responseDetailsContent');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        resultDiv.className = 'result result-loading';
        resultDiv.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <div>–û—Ç–ø—Ä–∞–≤–∫–∞ ${requestType}...</div>
                    <div style="font-size: 12px; margin-top: 10px;">initData: ${initData.substring(0, 50)}...</div>
                </div>
            `;

        detailsDiv.style.display = 'none';

        try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const requestData = {
                value: value,
                initData: initData
            };

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestData);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å
            const response = await fetch('/api/submit-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            let result;
            try {
                result = await response.json();
            } catch {
                result = {
                    status: 'error',
                    detail: `–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON. –°—Ç–∞—Ç—É—Å: ${response.status}`
                };
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const statusCode = response.status;
            const statusText = response.statusText;

            if (response.ok) {
                resultDiv.className = 'result result-success';
                resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 24px; margin-right: 10px;">‚úÖ</span>
                            <span style="font-weight: bold; font-size: 18px;">–£–°–ü–ï–•</span>
                        </div>
                        <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusCode} ${statusText}</div>
                        <div><strong>–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:</strong> ${requestType}</div>
                        <div><strong>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</strong> ${result.message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'}</div>
                    `;

                addTestResult(`${requestType}: –£—Å–ø–µ—à–Ω–æ (${statusCode})`, 'success');
            } else {
                resultDiv.className = 'result result-error';
                resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 24px; margin-right: 10px;">‚ùå</span>
                            <span style="font-weight: bold; font-size: 18px;">–û–®–ò–ë–ö–ê</span>
                        </div>
                        <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusCode} ${statusText}</div>
                        <div><strong>–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:</strong> ${requestType}</div>
                        <div><strong>–û—à–∏–±–∫–∞:</strong> ${result.detail || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
                    `;

                addTestResult(`${requestType}: –û—à–∏–±–∫–∞ ${statusCode} - ${result.detail || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π'}`, 'error');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞
            detailsContent.textContent = JSON.stringify({
                request_type: requestType,
                status_code: statusCode,
                status_text: statusText,
                request_data: {
                    value: value,
                    initData_length: initData.length
                },
                response: result
            }, null, 2);

            detailsDiv.style.display = 'block';

        } catch (error) {
            resultDiv.className = 'result result-error';
            resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">üî•</span>
                        <span style="font-weight: bold; font-size: 18px;">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</span>
                    </div>
                    <div><strong>–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:</strong> ${requestType}</div>
                    <div><strong>–û—à–∏–±–∫–∞:</strong> ${error.message}</div>
                    <div><strong>–¢–∏–ø –æ—à–∏–±–∫–∏:</strong> ${error.name}</div>
                `;

            detailsContent.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}\n\nStack trace:\n${error.stack}`;
            detailsDiv.style.display = 'block';

            addTestResult(`${requestType}: –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ - ${error.message}`, 'critical');
        }
    }

    // –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    function addTestResult(message, type) {
        const timestamp = new Date().toLocaleTimeString();
        const testResult = {
            timestamp,
            message,
            type,
            id: Date.now()
        };

        testResults.unshift(testResult); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 20 –∑–∞–ø–∏—Å—è–º–∏
        if (testResults.length > 20) {
            testResults = testResults.slice(0, 20);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
        updateTestSummary();

        // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
        console.log(`[${timestamp}] ${type}: ${message}`);
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–∫—É —Ç–µ—Å—Ç–æ–≤
    function updateTestSummary() {
        const summaryDiv = document.getElementById('testSummary');

        const successCount = testResults.filter(r => r.type === 'success').length;
        const errorCount = testResults.filter(r => r.type === 'error').length;
        const warningCount = testResults.filter(r => r.type === 'warning').length;
        const criticalCount = testResults.filter(r => r.type === 'critical').length;
        const infoCount = testResults.filter(r => r.type === 'info').length;
        const totalCount = testResults.length;

        let summaryHtml = `
                <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                    <span class="status-badge status-valid">‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}</span>
                    <span class="status-badge status-invalid">‚ùå –û—à–∏–±–∫–∏: ${errorCount}</span>
                    <span class="status-badge" style="background: #ffc107; color: #212529;">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${warningCount}</span>
                    <span class="status-badge" style="background: #dc3545; color: white;">üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: ${criticalCount}</span>
                    <span class="status-badge status-unknown">‚ÑπÔ∏è –ò–Ω—Ñ–æ: ${infoCount}</span>
                    <span class="status-badge" style="background: #6f42c1; color: white;">üìä –í—Å–µ–≥–æ: ${totalCount}</span>
                </div>
            `;

        // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if (testResults.length > 0) {
            summaryHtml += `
                    <h4 style="margin-top: 15px;">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h4>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                `;

            testResults.slice(0, 5).forEach(result => {
                let badgeColor = '';
                switch (result.type) {
                    case 'success':
                        badgeColor = 'status-valid';
                        break;
                    case 'error':
                        badgeColor = 'status-invalid';
                        break;
                    case 'critical':
                        badgeColor = 'status-invalid';
                        break;
                    case 'warning':
                        badgeColor = '';
                        break;
                    default:
                        badgeColor = 'status-unknown';
                }

                summaryHtml += `
                        <div style="margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee;">
                            <span class="status-badge ${badgeColor}" style="font-size: 10px; padding: 2px 8px;">${result.type}</span>
                            <span style="font-size: 12px; color: #666; margin: 0 10px;">${result.timestamp}</span>
                            <span style="font-size: 12px;">${result.message}</span>
                        </div>
                    `;
            });

            summaryHtml += `</div>`;
        }

        summaryDiv.innerHTML = summaryHtml;
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞
    function copyResponseDetails() {
        const content = document.getElementById('responseDetailsContent').textContent;
        navigator.clipboard.writeText(content).then(() => {
            alert('–î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        }).catch(err => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + err);
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

        // –ï—Å–ª–∏ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        if (tg) {
            tg.ready();
            tg.expand();

            setTimeout(() => {
                loadCurrentData();
                addTestResult('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
            }, 500);
        } else {
            addTestResult('Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)', 'info');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
        updateTestSummary();
    });
</script>
</body>
</html>