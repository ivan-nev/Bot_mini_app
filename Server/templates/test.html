<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #4CAF50;
        }

        .status-card.error {
            border-left-color: #f44336;
        }

        .status-card.warning {
            border-left-color: #ff9800;
        }

        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 25px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-bottom: 15px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: #6c757d;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .log-entry {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .log-time {
            color: #888;
        }

        .log-level-info {
            color: #4CAF50;
        }

        .log-level-warn {
            color: #ff9800;
        }

        .log-level-error {
            color: #f44336;
        }

        .log-level-debug {
            color: #2196F3;
        }
    </style>
</head>
<body>
<h1 style="color: white;">üîç –¢–µ—Å—Ç Mini App Telegram</h1>

<div class="container">
    <div id="statusCard" class="status-card">
        <h2>–°—Ç–∞—Ç—É—Å: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</h2>
        <p id="statusText">–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ...</p>
    </div>

    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
            <div id="platform" class="info-value">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">–ë—Ä–∞—É–∑–µ—Ä</div>
            <div id="browser" class="info-value">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">Telegram API</div>
            <div id="telegramApi" class="info-value">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">–í–µ—Ä—Å–∏—è WebApp</div>
            <div id="webappVersion" class="info-value">-</div>
        </div>
    </div>

    <button id="sendButton" class="button" disabled>
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å "OK" –±–æ—Ç—É
    </button>

    <button id="testRequest" class="button secondary">
        –¢–µ—Å—Ç –æ–±—ã—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ Telegram API)
    </button>

    <div class="loader" id="loader"></div>

    <div class="log-container" id="logContainer">
        [–õ–æ–≥ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å]
    </div>

    <button onclick="clearLogs()" class="button secondary" style="background: #dc3545;">
        –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
    </button>
</div>

<script>
    const logs = [];
    let telegram = null;
    let isTelegramWebApp = false;

    function log(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = {
            timestamp,
            level,
            message,
            data
        };

        logs.push(logEntry);

        const logElement = document.getElementById('logContainer');
        const logEntryElement = document.createElement('div');
        logEntryElement.className = 'log-entry';
        logEntryElement.innerHTML = `
                <span class="log-time">[${timestamp}]</span>
                <span class="log-level-${level}"> ${level.toUpperCase()}: </span>
                ${message}
                ${data ? `<br><small>${JSON.stringify(data, null, 2)}</small>`
    :
        ''
    }

    `;

            logElement.appendChild(logEntryElement);
            logElement.scrollTop = logElement.scrollHeight;

            console.log(`[${level}]${message}`, data || '');
        }

        function updateStatus(status, message, isError = false) {
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('statusText');

            statusCard.className = `
    status - card${isError ? 'error' : ''}`;
            document.querySelector('#statusCard h2').textContent = `
    –°—Ç–∞—Ç—É—Å: ${status}`;
            statusText.textContent = message;
        }

        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browser = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

            if (userAgent.includes('YaBrowser') || userAgent.includes('Yowser')) {
                browser = 'Yandex Browser';
            } else if (userAgent.includes('Chrome')) {
                browser = 'Google Chrome';
            } else if (userAgent.includes('Firefox')) {
                browser = 'Firefox';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                browser = 'Safari';
            } else if (userAgent.includes('Edg')) {
                browser = 'Microsoft Edge';
            }

            document.getElementById('browser').textContent = browser;
            log('info', `
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω
    –±—Ä–∞—É–∑–µ—Ä: ${browser}`);
            return browser;
        }

        function detectPlatform() {
            const userAgent = navigator.userAgent;
            let platform = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

            if (/android/i.test(userAgent)) {
                platform = 'Android';
            } else if (/iPad|iPhone|iPod/.test(userAgent)) {
                platform = 'iOS';
            } else if (/Win/.test(userAgent)) {
                platform = 'Windows';
            } else if (/Mac/.test(userAgent)) {
                platform = 'macOS';
            } else if (/Linux/.test(userAgent)) {
                platform = 'Linux';
            }

            document.getElementById('platform').textContent = platform;
            log('info', `
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
    –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${platform}`);
            return platform;
        }

        function initTelegramWebApp() {
            log('info', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram WebApp API...');

            if (window.Telegram && window.Telegram.WebApp) {
                telegram = window.Telegram.WebApp;
                isTelegramWebApp = true;

                log('info', 'Telegram WebApp API –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                log('debug', '–û–±—ä–µ–∫—Ç Telegram.WebApp:', {
                    initData: telegram.initData,
                    initDataUnsafe: telegram.initDataUnsafe,
                    platform: telegram.platform,
                    version: telegram.version,
                    colorScheme: telegram.colorScheme,
                    themeParams: telegram.themeParams
                });

                document.getElementById('telegramApi').textContent = '–î–æ—Å—Ç—É–ø–µ–Ω';
                document.getElementById('webappVersion').textContent = telegram.version;

                updateStatus('–ì–æ—Ç–æ–≤', 'Telegram WebApp API –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');

                telegram.ready();
                telegram.expand();

                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = false;
                sendButton.innerHTML = 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å "OK" –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram API';

                log('info', '–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');

            } else {
                log('warn', 'Telegram WebApp API –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram?');
                document.getElementById('telegramApi').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                document.getElementById('webappVersion').textContent = 'N/A';

                updateStatus('–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º', 'Telegram WebApp API –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram.', true);

                log('info', '–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–∏');
            }
        }

        async function sendViaTelegramAPI() {
            if (!isTelegramWebApp || !telegram) {
                log('error', '–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram API, –Ω–æ API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                updateStatus('–û—à–∏–±–∫–∞', 'Telegram API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', true);
                return;
            }

            const loader = document.getElementById('loader');
            const sendButton = document.getElementById('sendButton');

            loader.style.display = 'block';
            sendButton.disabled = true;
            sendButton.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            log('info', '–ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ Telegram WebApp API...');
            log('debug', '–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', {
                command: 'send_ok',
                timestamp: Date.now(),
                test_data: 'OK from Mini App'
            });

            try {
                // –ú–µ—Ç–æ–¥ 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º sendData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞
                telegram.sendData(JSON.stringify({
                    command: 'send_ok',
                    timestamp: Date.now(),
                    test_data: 'OK from Mini App',
                    browser: detectBrowser(),
                    platform: detectPlatform()
                }));

                log('info', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ telegram.sendData()');
                updateStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', '–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram API');

                // –ú–µ—Ç–æ–¥ 2: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                telegram.showPopup({
                    title: '–£—Å–ø–µ—à–Ω–æ!',
                    message: '–î–∞–Ω–Ω—ã–µ "OK" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram WebApp API.',
                    buttons: [{ type: 'ok' }]
                });

            } catch (error) {
                log('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–µ–∑ Telegram API:', error);
                updateStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', error.message, true);

                telegram.showPopup({
                    title: '–û—à–∏–±–∫–∞!',
                    message: `
    –ù–µ
    —É–¥–∞–ª–æ—Å—å
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    –¥–∞–Ω–Ω—ã–µ: ${error.message}`,
                    buttons: [{ type: 'ok' }]
                });
            } finally {
                loader.style.display = 'none';
                sendButton.disabled = false;
                sendButton.innerHTML = 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å "OK" –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram API';

                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ initData (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                log('debug', '–¢–µ–∫—É—â–∏–π initData:', telegram.initData);
                log('debug', '–¢–µ–∫—É—â–∏–π initDataUnsafe:', telegram.initDataUnsafe);

                if (telegram.initData) {
                    log('info', 'InitData –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–ª–∏–Ω–∞: ' + telegram.initData.length);
                } else {
                    log('warn', 'InitData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –≤ Chrome');
                }
            }
        }

        async function testRegularRequest() {
            const loader = document.getElementById('loader');
            const testButton = document.getElementById('testRequest');

            loader.style.display = 'block';
            testButton.disabled = true;
            testButton.innerHTML = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';

            log('info', '–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π HTTP-–∑–∞–ø—Ä–æ—Å...');

            try {
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–∏
                const response = await fetch('https://httpbin.org/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: 'OK',
                        message: '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ Mini App',
                        timestamp: Date.now(),
                        browser: detectBrowser(),
                        platform: detectPlatform(),
                        userAgent: navigator.userAgent
                    })
                });

                const data = await response.json();

                log('info', '–¢–µ—Å—Ç–æ–≤—ã–π HTTP-–∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                log('debug', '–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                updateStatus('–°–µ—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç', '–û–±—ã—á–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–æ–ø–∞–ø–µ –µ—Å–ª–∏ –≤ Telegram
                if (isTelegramWebApp) {
                    telegram.showPopup({
                        title: '–°–µ—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç!',
                        message: '–û–±—ã—á–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ.',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                }

            } catch (error) {
                log('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–º HTTP-–∑–∞–ø—Ä–æ—Å–µ:', error);
                updateStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å', true);

                if (isTelegramWebApp) {
                    telegram.showPopup({
                        title: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!',
                        message: `
    HTTP - –∑–∞–ø—Ä–æ—Å
    –Ω–µ
    —É–¥–∞–ª—Å—è: ${error.message}`,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert(`
    –û—à–∏–±–∫–∞
    —Å–µ—Ç–∏: ${error.message}`);
                }
            } finally {
                loader.style.display = 'none';
                testButton.disabled = false;
                testButton.innerHTML = '–¢–µ—Å—Ç –æ–±—ã—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ Telegram API)';
            }
        }

        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '[–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã]';
            logs.length = 0;
            log('info', '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            log('info', '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log('debug', 'UserAgent:', navigator.userAgent);
            log('debug', 'URL:', window.location.href);
            log('debug', 'Referrer:', document.referrer);

            detectBrowser();
            detectPlatform();
            initTelegramWebApp();

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('sendButton').addEventListener('click', sendViaTelegramAPI);
            document.getElementById('testRequest').addEventListener('click', testRegularRequest);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å" –≤ Telegram
            if (isTelegramWebApp) {
                telegram.BackButton.show();
                telegram.BackButton.onClick(() => {
                    telegram.close();
                });
            }

            log('info', '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        });

        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è Telegram WebApp –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;

            // –õ–æ–≥–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
            tg.onEvent('viewportChanged', (data) => {
                log('debug', '–°–æ–±—ã—Ç–∏–µ viewportChanged:', data);
            });

            tg.onEvent('themeChanged', () => {
                log('debug', '–°–æ–±—ã—Ç–∏–µ themeChanged, —Ç–µ–∫—É—â–∞—è —Ç–µ–º–∞:', tg.colorScheme);
            });

            tg.onEvent('mainButtonClicked', () => {
                log('debug', '–°–æ–±—ã—Ç–∏–µ mainButtonClicked');
            });
        }
    </script>
</body>
</html>