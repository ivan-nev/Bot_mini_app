<script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    let tg;
    try {
        tg = window.Telegram?.WebApp;
        if (!tg) {
            throw new Error("WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
        }
    } catch (e) {
        document.getElementById('status').textContent = '‚ùå SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!';
        document.getElementById('status').style.display = 'block';
        document.getElementById('status').className = 'status error';
        console.error("Telegram WebApp SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω", e);
        throw e;
    }

    // –†–∞—Å—à–∏—Ä—è–µ–º –æ–∫–Ω–æ –∏ –≥–æ—Ç–æ–≤–∏–º WebApp
    tg.expand();
    tg.ready();

    // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
    console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:', {
        platform: tg.platform,
        version: tg.version,
        isMobile: isMobile,
        initData: tg.initData ? '–ï—Å—Ç—å' : '–ù–µ—Ç'
    });

    const form = document.getElementById('dataForm');
    const statusEl = document.getElementById('status');

    function showStatus(message, isError = false) {
        console.log("–°—Ç–∞—Ç—É—Å:", message);
        statusEl.textContent = message;
        statusEl.className = 'status' + (isError ? ' error' : '');
        statusEl.style.display = 'block';
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 5000);
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    function sendData(data) {
        try {
            const dataString = JSON.stringify(data);
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", dataString);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Ç–æ–¥–∞
            if (!tg.sendData) {
                showStatus('‚ùå –ú–µ—Ç–æ–¥ sendData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', true);
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
                tryAlternativeSend(data);
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            tg.sendData(dataString);
            showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç!');
            form.reset();

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ sendData:", error);
            showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, true);

            // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
            tryAlternativeSend(data);
        }
    }

    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏
    function tryAlternativeSend(data) {
        console.log("–ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏...");

        // –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º postMessage
        try {
            if (window.parent !== window) {
                window.parent.postMessage({
                    eventType: 'sendData',
                    data: data
                }, '*');
                console.log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ postMessage");
            }
        } catch (e) {
            console.error("postMessage –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:", e);
        }

        // –°–ø–æ—Å–æ–± 2: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if (isMobile) {
            setTimeout(() => {
                showStatus('üì± –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∏–Ω–∞—á–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.', false);
            }, 1000);
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const title = document.getElementById('title').value.trim();
        const desc = document.getElementById('desc').value.trim();
        const text = document.getElementById('text').value.trim();

        if (!title || !text) {
            showStatus('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç!', true);
            return;
        }

        const data = {
            title,
            desc,
            text,
            timestamp: new Date().toISOString(),
            platform: isMobile ? 'mobile' : 'desktop'
        };

        sendData(data);
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    function setupInterface() {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–æ—Ä–º—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º MainButton
        if (isMobile && tg.MainButton) {
            const formBtn = document.querySelector('.btn');
            formBtn.style.display = 'none';

            tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å");
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                form.dispatchEvent(new Event('submit'));
            });
        }

        // BackButton —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
        if (tg.BackButton && !isMobile) {
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                tg.close();
            });
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    document.addEventListener('DOMContentLoaded', setupInterface);
    tg.onEvent('ready', setupInterface);
</script>