<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тест отправки Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<h1>Тест отправки данных</h1>

<div id="status"></div>

<button onclick="testSendData()">Тест sendData</button>
<button onclick="testCopy()">Тест копирования</button>
<button onclick="showData()">Показать данные</button>

<pre id="log"></pre>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let log = document.getElementById('log');
    let status = document.getElementById('status');

    // Логирование
    function addLog(msg, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
        log.innerHTML += `<span style="color:${color}">[${time}] ${msg}</span><br>`;
        log.scrollTop = log.scrollHeight;
    }

    // Обновление статуса
    function updateStatus(msg, type = 'info') {
        status.innerHTML = msg;
        status.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
        addLog(`Платформа: ${tg.platform}`);
        addLog(`Версия: ${tg.version}`);
        addLog(`initData: ${tg.initData ? 'да' : 'нет'}`);
        addLog(`sendData доступен: ${typeof tg.sendData === 'function' ? 'да' : 'нет'}`);

        if (tg.initDataUnsafe?.user) {
            addLog(`Пользователь: ${tg.initDataUnsafe.user.first_name} (ID: ${tg.initDataUnsafe.user.id})`);
        }
    });

    // Тест sendData
    function testSendData() {
        updateStatus('Отправка...', 'info');
        const testData = {
            action: "test",
            platform: tg.platform,
            time: new Date().toISOString(),
            number: Math.random()
        };

        addLog(`Отправка: ${JSON.stringify(testData)}`);
        addLog(`Размер: ${JSON.stringify(testData).length} байт`);

        try {
            const success = tg.sendData(JSON.stringify(testData));
            if (success) {
                addLog('sendData вернул true', 'success');
                updateStatus('Успешно отправлено!', 'success');
            } else {
                addLog('sendData вернул false', 'error');
                updateStatus('sendData вернул false', 'error');
            }
        } catch (e) {
            addLog(`Ошибка: ${e.message}`, 'error');
            updateStatus(`Ошибка: ${e.message}`, 'error');
        }
    }

    // Тест копирования
    function testCopy() {
        const text = `Тестовые данные: ${new Date().toLocaleString()}\nПлатформа: ${tg.platform}\nID: ${tg.initDataUnsafe?.user?.id || 'нет'}`;

        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();

        try {
            const success = document.execCommand('copy');
            if (success) {
                addLog('Скопировано в буфер', 'success');
                updateStatus('Скопировано!', 'success');
                tg.showAlert('Текст скопирован в буфер обмена');
            } else {
                addLog('Не удалось скопировать', 'error');
                updateStatus('Ошибка копирования', 'error');
            }
        } catch (e) {
            addLog(`Ошибка копирования: ${e.message}`, 'error');
            updateStatus('Ошибка копирования', 'error');
        }

        document.body.removeChild(textarea);
    }

    // Показать все данные
    function showData() {
        const data = {
            platform: tg.platform,
            version: tg.version,
            initData: tg.initData,
            initDataUnsafe: tg.initDataUnsafe,
            allKeys: Object.keys(tg).filter(k => typeof tg[k] === 'function')
        };

        addLog(`Все данные: ${JSON.stringify(data, null, 2)}`);
        updateStatus('Данные показаны в логе', 'info');
    }
</script>
</body>
</html>